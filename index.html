<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nghe và Viết Tiếng Anh</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tải font tùy chỉnh */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-4">

    <header class="bg-white shadow-lg rounded-xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-4 md:mb-0">
            Nghe và Viết Tiếng Anh
        </h1>
        <nav class="space-x-2 sm:space-x-4 flex flex-wrap justify-center">
            <button id="home-nav-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 text-sm sm:text-base mb-2 sm:mb-0">
                Trang Chủ
            </button>
            <button id="teacher-nav-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105 text-sm sm:text-base mb-2 sm:mb-0">
                Giáo Viên
            </button>
            <button id="student-nav-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105 text-sm sm:text-base">
                Học Sinh
            </button>
        </nav>
    </header>

    <main id="app-main-content" class="container mx-auto">
        <!-- Nội dung sẽ được tải động bằng JavaScript -->
        <div class="text-center text-gray-600 text-xl mt-10">Đang tải dữ liệu...</div>
    </main>

    <!-- Cấu trúc Modal xác nhận xóa -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Xác nhận xóa</h3>
            <p class="text-gray-700 mb-6">
                Bạn có chắc chắn muốn xóa bài tập <span id="exercise-to-delete-id"></span> không?
            </p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-300">
                    Hủy
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">
                    Xóa
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Biến trạng thái toàn cục
        let currentView = 'home';
        let exercises = []; // Mảng này sẽ được điền từ Firestore
        let selectedExercise = null;
        let exerciseToDelete = null;

        // Biến Firebase
        let app;
        let auth;
        let db;
        let userId = 'anonymous'; // Mặc định là người dùng ẩn danh
        let authReady = false; // Cờ để đảm bảo các thao tác Firestore chờ xác thực

        // CẤU HÌNH FIREBASE CỦA BẠN
        // Bạn có thể tìm cấu hình Firebase của mình trong cài đặt dự án Firebase:
        // Cài đặt dự án -> Ứng dụng của bạn -> Ứng dụng web -> Đoạn mã SDK Firebase -> Cấu hình
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Hàm trợ giúp để chuyển đổi File sang Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Hàm hiển thị thông báo
        function showMessage(element, msg, classes) {
            element.innerHTML = `<div class="${classes} px-4 py-3 rounded relative mb-4" role="alert">
                                    <span class="block sm:inline">${msg}</span>
                                </div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // Hàm để thêm bài tập vào Firestore
        async function addExerciseToFirestore(exerciseData) {
            if (!db || !authReady) {
                console.error("Firestore hoặc xác thực chưa sẵn sàng.");
                return false;
            }
            try {
                // Lưu trữ dữ liệu công khai, có thể truy cập bởi bất kỳ người dùng nào đã xác thực
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/exercises`), {
                    ...exerciseData,
                    createdBy: userId,
                    createdAt: new Date().toISOString()
                });
                console.log("Bài tập được thêm với ID: ", docRef.id);
                return true;
            } catch (e) {
                console.error("Lỗi khi thêm tài liệu: ", e);
                return false;
            }
        }

        // Hàm để xóa bài tập khỏi Firestore
        async function deleteExerciseFromFirestore(exerciseId) {
            if (!db || !authReady) {
                console.error("Firestore hoặc xác thực chưa sẵn sàng.");
                return false;
            }
            try {
                // Xóa tài liệu khỏi bộ sưu tập công khai
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/exercises`, exerciseId));
                console.log("Bài tập đã được xóa thành công!");
                return true;
            } catch (e) {
                console.error("Lỗi khi xóa tài liệu: ", e);
                return false;
            }
        }

        // Hàm để render các chế độ xem khác nhau
        function renderView() {
            const mainContent = document.getElementById('app-main-content');
            mainContent.innerHTML = ''; // Xóa nội dung hiện tại

            // Chỉ render nếu xác thực Firebase đã sẵn sàng
            if (!authReady) {
                mainContent.innerHTML = '<div class="text-center text-gray-600 text-xl mt-10">Đang tải dữ liệu...</div>';
                return;
            }

            // Hiển thị userId để gỡ lỗi
            const userIdDisplay = document.createElement('div');
            userIdDisplay.className = 'text-center text-gray-500 text-sm mb-4';
            userIdDisplay.textContent = `ID Người dùng: ${userId}`;
            mainContent.appendChild(userIdDisplay);


            switch (currentView) {
                case 'home':
                    renderHomeView(mainContent);
                    break;
                case 'teacher':
                    renderTeacherDashboard(mainContent);
                    break;
                case 'student':
                    if (selectedExercise) {
                        renderExercisePlayer(mainContent, selectedExercise);
                    } else {
                        renderStudentDashboard(mainContent);
                    }
                    break;
                default:
                    renderHomeView(mainContent);
            }
        }

        // Thành phần Chế độ xem Trang chủ
        function renderHomeView(parentDiv) {
            const homeDiv = document.createElement('div');
            homeDiv.className = 'bg-white p-8 rounded-xl shadow-lg text-center';
            homeDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Chào mừng bạn!</h2>
                <p class="text-lg text-gray-600 mb-8">
                    Chọn vai trò của bạn để bắt đầu.
                </p>
                <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6">
                    <button id="home-teacher-btn" class="px-8 py-4 bg-green-500 text-white text-xl font-semibold rounded-lg shadow-xl hover:bg-green-600 transition duration-300 transform hover:scale-105">
                        Tôi là Giáo Viên
                    </button>
                    <button id="home-student-btn" class="px-8 py-4 bg-purple-500 text-white text-xl font-semibold rounded-lg shadow-xl hover:bg-purple-600 transition duration-300 transform hover:scale-105">
                        Tôi là Học Sinh
                    </button>
                </div>
            `;
            parentDiv.appendChild(homeDiv);

            document.getElementById('home-teacher-btn').addEventListener('click', () => navigate('teacher'));
            document.getElementById('home-student-btn').addEventListener('click', () => navigate('student'));
        }

        // Thành phần Bảng điều khiển Giáo viên
        function renderTeacherDashboard(parentDiv) {
            const teacherDiv = document.createElement('div');
            teacherDiv.className = 'bg-white p-8 rounded-xl shadow-lg';
            teacherDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Quản lý Bài Giảng (Giáo Viên)</h2>
                <div id="teacher-message-area"></div>
                <form id="add-exercise-form" class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Tải Lên Bài Nghe Mới</h3>
                    <div class="mb-4">
                        <label htmlFor="folder" class="block text-gray-700 text-sm font-bold mb-2">
                            Thư mục/Chủ đề:
                        </label>
                        <input type="text" id="folder-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ví dụ: Bài 1, Chủ đề Gia đình..." />
                    </div>
                    <div class="mb-4">
                        <label htmlFor="audioFile" class="block text-gray-700 text-sm font-bold mb-2">
                            Tải File Ghi Âm (.mp3, .wav, v.v.):
                        </label>
                        <input type="file" id="audio-file-input" accept="audio/*" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <p id="audio-file-name" class="mt-2 text-sm text-gray-600"></p>
                    </div>
                    <div class="mb-6">
                        <label htmlFor="answerKey" class="block text-gray-700 text-sm font-bold mb-2">
                            Đáp án chính xác:
                        </label>
                        <textarea id="answer-key-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent h-32" placeholder="Nhập đáp án chính xác của bài nghe tại đây..."></textarea>
                    </div>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                        Thêm Bài Tập
                    </button>
                </form>

                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Các Bài Tập Đã Tải Lên</h3>
                <div id="exercises-list-container"></div>
            `;
            parentDiv.appendChild(teacherDiv);

            const messageArea = document.getElementById('teacher-message-area');
            const folderInput = document.getElementById('folder-input');
            const audioFileInput = document.getElementById('audio-file-input');
            const audioFileNameDisplay = document.getElementById('audio-file-name');
            const answerKeyInput = document.getElementById('answer-key-input');
            const addExerciseForm = document.getElementById('add-exercise-form');
            const exercisesListContainer = document.getElementById('exercises-list-container');

            let currentAudioFile = null;

            // Xử lý chọn tệp
            audioFileInput.addEventListener('change', (e) => {
                currentAudioFile = e.target.files[0];
                if (currentAudioFile) {
                    audioFileNameDisplay.textContent = `File đã chọn: ${currentAudioFile.name}`;
                } else {
                    audioFileNameDisplay.textContent = '';
                }
            });

            // Xử lý thêm bài tập mới
            addExerciseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const folder = folderInput.value.trim();
                const answerKey = answerKeyInput.value.trim();

                if (!answerKey || !folder || !currentAudioFile) {
                    showMessage(messageArea, 'Vui lòng điền đầy đủ các trường: Đáp án, Thư mục và chọn File Ghi Âm.', 'bg-red-100 border-red-400 text-red-700');
                    return;
                }

                try {
                    // Chuyển đổi tệp âm thanh sang chuỗi Base64
                    const audioBase64 = await fileToBase64(currentAudioFile);

                    const newExerciseData = {
                        folder,
                        audioContent: '', // Nội dung văn bản từ âm thanh nằm ngoài phạm vi của ứng dụng này
                        answerKey,
                        audioBase64: audioBase64, // Lưu chuỗi Base64 vào Firestore
                    };

                    const success = await addExerciseToFirestore(newExerciseData);
                    if (success) {
                        // Xóa biểu mẫu chỉ sau khi thêm thành công vào Firestore
                        folderInput.value = '';
                        answerKeyInput.value = '';
                        audioFileInput.value = ''; // Xóa đầu vào tệp
                        currentAudioFile = null;
                        audioFileNameDisplay.textContent = '';
                        showMessage(messageArea, 'Bài tập đã được thêm thành công!', 'bg-blue-100 border-blue-400 text-blue-700');
                    } else {
                        showMessage(messageArea, 'Lỗi khi thêm bài tập. Vui lòng thử lại.', 'bg-red-100 border-red-400 text-red-700');
                    }
                } catch (error) {
                    console.error("Lỗi khi xử lý tệp âm thanh hoặc thêm bài tập:", error);
                    showMessage(messageArea, 'Lỗi khi xử lý file âm thanh hoặc thêm bài tập.', 'bg-red-100 border-red-400 text-red-700');
                }
            });

            // Hàm để render danh sách các bài tập đã tải lên
            function renderExercisesList() {
                exercisesListContainer.innerHTML = ''; // Xóa danh sách trước đó

                const folders = [...new Set(exercises.map(ex => ex.folder))];

                if (folders.length === 0) {
                    exercisesListContainer.innerHTML = '<p class="text-gray-600">Chưa có bài tập nào được tải lên.</p>';
                    return;
                }

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

                folders.forEach(folderName => {
                    const exercisesInFolder = exercises.filter(ex => ex.folder === folderName);
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200';
                    folderDiv.innerHTML = `
                        <h4 class="text-xl font-semibold text-blue-800 mb-4">${folderName}</h4>
                        <ul class="list-disc list-inside text-gray-700" id="folder-${folderName.replace(/\s+/g, '-')}-list">
                            <!-- Các bài tập sẽ được thêm vào đây -->
                        </ul>
                    `;
                    gridDiv.appendChild(folderDiv);

                    const ul = folderDiv.querySelector(`#folder-${folderName.replace(/\s+/g, '-')}-list`);
                    exercisesInFolder.forEach(ex => {
                        const li = document.createElement('li');
                        li.className = 'mb-2 flex justify-between items-center';
                        li.innerHTML = `
                            <span>
                                ${ex.audioBase64 ? '<p class="text-sm text-gray-500 italic">(Đã có file audio)</p>' : ''}
                            </span>
                            <div class="flex space-x-2">
                                <button data-exercise-id="${ex.id}" class="delete-exercise-btn px-3 py-1 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600 transition duration-300 text-sm" title="Xóa bài tập">
                                    Xóa
                                </button>
                            </div>
                        `;
                        ul.appendChild(li);
                    });
                });
                exercisesListContainer.appendChild(gridDiv);

                // Thêm trình nghe sự kiện cho các nút xóa
                document.querySelectorAll('.delete-exercise-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const idToDelete = e.target.dataset.exerciseId;
                        const ex = exercises.find(item => item.id === idToDelete);
                        confirmDelete(ex);
                    });
                });
            }

            // Render ban đầu danh sách bài tập khi bảng điều khiển giáo viên tải
            renderExercisesList();
        }

        // Thành phần Bảng điều khiển Học sinh
        function renderStudentDashboard(parentDiv) {
            const studentDiv = document.createElement('div');
            studentDiv.className = 'bg-white p-8 rounded-xl shadow-lg';
            studentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Chọn Bài Tập (Học Sinh)</h2>
                <div id="student-exercises-list-container"></div>
            `;
            parentDiv.appendChild(studentDiv);

            const studentExercisesListContainer = document.getElementById('student-exercises-list-container');
            const folders = [...new Set(exercises.map(ex => ex.folder))];

            if (folders.length === 0) {
                studentExercisesListContainer.innerHTML = '<p class="text-gray-600">Chưa có bài tập nào. Vui lòng đợi giáo viên tải lên.</p>';
                return;
            }

            const gridDiv = document.createElement('div');
            gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

            folders.forEach(folderName => {
                const exercisesInFolder = exercises.filter(ex => ex.folder === folderName);
                const folderDiv = document.createElement('div');
                folderDiv.className = 'bg-purple-50 p-6 rounded-lg shadow-md border border-purple-200';
                folderDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-purple-800 mb-4">${folderName}</h3>
                    <ul class="list-disc list-inside text-gray-700" id="student-folder-${folderName.replace(/\s+/g, '-')}-list">
                        <!-- Các bài tập sẽ được thêm vào đây -->
                    </ul>
                `;
                gridDiv.appendChild(folderDiv);

                const ul = folderDiv.querySelector(`#student-folder-${folderName.replace(/\s+/g, '-')}-list`);
                exercisesInFolder.forEach(ex => {
                    const li = document.createElement('li');
                    li.className = 'mb-2';
                    li.innerHTML = `
                        <button data-exercise-id="${ex.id}" class="select-exercise-btn text-blue-600 hover:text-blue-800 font-medium hover:underline transition duration-200">
                            Bài tập trong ${ex.folder}
                        </button>
                    `;
                    ul.appendChild(li);
                });
            });
            studentExercisesListContainer.appendChild(gridDiv);

            // Thêm trình nghe sự kiện để chọn bài tập
            document.querySelectorAll('.select-exercise-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToSelect = e.target.dataset.exerciseId;
                    selectedExercise = exercises.find(item => item.id === idToSelect);
                    renderView(); // Render lại để hiển thị ExercisePlayer
                });
            });
        }

        // Thành phần Trình phát Bài tập và Chấm điểm
        function renderExercisePlayer(parentDiv, exercise) {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'bg-white p-8 rounded-xl shadow-lg';
            playerDiv.innerHTML = `
                <button id="back-to-student-dashboard" class="mb-6 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300">
                    &larr; Quay lại
                </button>
                <h2 class="text-3xl font-bold text-gray-800 mb-6">
                    Bài Tập: ${exercise.folder}
                </h2>

                <div class="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">Nội dung bài nghe:</h3>
                    ${exercise.audioBase64 ? `
                        <div class="mb-4">
                            <audio controls class="w-full rounded-md">
                                <source src="${exercise.audioBase64}" type="audio/mpeg" />
                                Trình duyệt của bạn không hỗ trợ phần tử audio.
                            </audio>
                            <p class="mt-2 text-sm text-gray-600">
                                Đây là file ghi âm đã được giáo viên tải lên.
                            </p>
                            <p class="mt-2 text-sm text-red-500">
                                Lưu ý: Các tệp âm thanh được lưu trữ dưới dạng văn bản (Base64) trong cơ sở dữ liệu. Điều này có thể làm tăng kích thước tài liệu và không phù hợp cho các tệp lớn.
                            </p>
                        </div>
                    ` : `
                        <p class="text-gray-600 italic mb-4">
                            Chưa có file ghi âm được tải lên cho bài tập này.
                        </p>
                    `}

                    ${exercise.audioContent ? `
                        <button id="show-audio-content-btn" class="px-6 py-3 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition duration-300 transform hover:scale-105 mb-4">
                            Xem Nội dung Bài Nghe (Văn bản)
                        </button>
                    ` : ''}
                    
                    <p id="audio-content-display" class="text-gray-700 italic border-l-4 border-blue-400 pl-4 py-2 bg-blue-100 rounded-md hidden">
                        ${exercise.audioContent || ''}
                    </p>
                    ${!exercise.audioContent ? `
                        <p class="text-gray-600 italic">
                            Không có nội dung văn bản cho bài nghe này.
                        </p>
                    ` : ''}
                </div>

                <div class="mb-6">
                    <label htmlFor="studentInput" class="block text-gray-700 text-sm font-bold mb-2">
                        Bài làm của bạn:
                    </label>
                    <textarea id="student-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent h-40" placeholder="Gõ bài làm của bạn vào đây..."></textarea>
                </div>

                <button id="grade-submission-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                    Chấm Điểm
                </button>

                <div id="graded-result-area" class="mt-8 p-6 border border-green-200 rounded-lg bg-green-50 hidden">
                    <h3 class="text-2xl font-semibold text-green-800 mb-4">Kết Quả Chấm Điểm:</h3>
                    <p class="text-xl font-bold text-gray-800 mb-4">
                        Điểm số: <span id="score-display" class="text-green-600"></span>
                    </p>
                    <div id="result-text-display" class="text-lg leading-relaxed"></div>
                    <p class="mt-4 text-sm text-gray-600">
                        <span class="text-red-600 font-bold">Màu đỏ:</span> Từ sai.
                        <span class="text-yellow-600 font-bold ml-4">Màu vàng gạch chân:</span> Từ thiếu (hệ thống bổ sung).
                        <span class="text-gray-800 ml-4">Màu đen:</span> Từ đúng.
                    </p>
                </div>
            `;
            parentDiv.appendChild(playerDiv);

            const studentInput = document.getElementById('student-input');
            const gradeSubmissionBtn = document.getElementById('grade-submission-btn');
            const gradedResultArea = document.getElementById('graded-result-area');
            const scoreDisplay = document.getElementById('score-display');
            const resultTextDisplay = document.getElementById('result-text-display');
            const showAudioContentBtn = document.getElementById('show-audio-content-btn');
            const audioContentDisplay = document.getElementById('audio-content-display');

            // Đặt giá trị ban đầu cho đầu vào của học sinh nếu nó đã được đặt trước đó
            studentInput.value = exercise.studentInput || '';

            // Xử lý nút quay lại
            document.getElementById('back-to-student-dashboard').addEventListener('click', () => {
                selectedExercise = null;
                renderView();
            });

            // Xử lý nút hiển thị nội dung âm thanh
            if (showAudioContentBtn) {
                showAudioContentBtn.addEventListener('click', () => {
                    audioContentDisplay.classList.remove('hidden');
                });
            }

            // Xử lý chấm điểm
            gradeSubmissionBtn.addEventListener('click', () => {
                // Lưu đầu vào hiện tại của học sinh vào đối tượng bài tập (để duy trì nếu điều hướng đi và quay lại)
                exercise.studentInput = studentInput.value;

                const studentWords = studentInput.value.toLowerCase().split(/\s+/).filter(word => word.length > 0);
                const answerWords = exercise.answerKey.toLowerCase().split(/\s+/).filter(word => word.length > 0);

                const result = [];
                let studentIndex = 0;
                let answerIndex = 0;
                let correctCount = 0;

                while (answerIndex < answerWords.length) {
                    if (studentIndex < studentWords.length && studentWords[studentIndex] === answerWords[answerIndex]) {
                        result.push({ word: answerWords[answerIndex], status: 'correct' });
                        correctCount++;
                        studentIndex++;
                        answerIndex++;
                    } else {
                        let foundMatch = false;
                        if (studentIndex < studentWords.length) {
                            for (let i = 1; i <= 3 && (answerIndex + i) < answerWords.length; i++) {
                                if (studentWords[studentIndex] === answerWords[answerIndex + i]) {
                                    for (let j = 0; j < i; j++) {
                                        result.push({ word: answerWords[answerIndex + j], status: 'missing' });
                                    }
                                    answerIndex += i;
                                    foundMatch = true;
                                    break;
                                }
                            }
                        }

                        if (!foundMatch) {
                            if (studentIndex < studentWords.length) {
                                result.push({ word: studentWords[studentIndex], status: 'incorrect' });
                                studentIndex++;
                            } else {
                                result.push({ word: answerWords[answerIndex], status: 'missing' });
                                answerIndex++;
                            }
                        }
                    }
                }

                while (studentIndex < studentWords.length) {
                    result.push({ word: studentWords[studentIndex], status: 'incorrect' });
                    studentIndex++;
                }

                const score = (correctCount / answerWords.length) * 100;

                // Hiển thị kết quả
                gradedResultArea.classList.remove('hidden');
                scoreDisplay.textContent = `${score.toFixed(2)}%`;
                resultTextDisplay.innerHTML = ''; // Xóa kết quả trước đó

                result.forEach((item, index) => {
                    const span = document.createElement('span');
                    span.className = `
                        ${item.status === 'correct' ? 'text-gray-800' : ''}
                        ${item.status === 'incorrect' ? 'text-red-600 font-bold' : ''}
                        ${item.status === 'missing' ? 'text-yellow-600 font-bold underline' : ''}
                        mr-1
                    `;
                    span.textContent = item.word + ' ';
                    resultTextDisplay.appendChild(span);
                });
            });
        }

        // Hàm điều hướng
        function navigate(view) {
            currentView = view;
            selectedExercise = null; // Đặt lại bài tập đã chọn khi chuyển đổi chế độ xem
            renderView();
        }

        // Trình nghe sự kiện cho các nút điều hướng chính
        document.getElementById('home-nav-btn').addEventListener('click', () => navigate('home'));
        document.getElementById('teacher-nav-btn').addEventListener('click', () => navigate('teacher'));
        document.getElementById('student-nav-btn').addEventListener('click', () => navigate('student'));

        // Logic Modal xác nhận xóa
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const exerciseToDeleteIdSpan = document.getElementById('exercise-to-delete-id');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        function confirmDelete(exercise) {
            exerciseToDelete = exercise;
            exerciseToDeleteIdSpan.textContent = "này"; // Văn bản chung
            deleteConfirmModal.classList.remove('hidden');
        }

        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmModal.classList.add('hidden');
            exerciseToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (exerciseToDelete) {
                const success = await deleteExerciseFromFirestore(exerciseToDelete.id);
                if (success) {
                    deleteConfirmModal.classList.add('hidden');
                    exerciseToDelete = null;
                    // Trình nghe onSnapshot sẽ tự động render lại danh sách
                    const messageArea = document.getElementById('teacher-message-area');
                    if (messageArea) {
                        showMessage(messageArea, `Bài tập đã được xóa thành công.`, 'bg-blue-100 border-blue-400 text-blue-700');
                    }
                } else {
                    const messageArea = document.getElementById('teacher-message-area');
                    if (messageArea) {
                        showMessage(messageArea, 'Lỗi khi xóa bài tập. Vui lòng thử lại.', 'bg-red-100 border-red-400 text-red-700');
                    }
                }
            }
        });

        // Thiết lập Firebase và tải dữ liệu
        window.onload = async () => {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Đăng nhập người dùng ẩn danh hoặc với token tùy chỉnh
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Người dùng đã đăng nhập:", userId);
                } else {
                    userId = 'anonymous';
                    console.log("Người dùng ẩn danh.");
                }
                authReady = true; // Đặt cờ là true sau khi xác thực đã sẵn sàng
                renderView(); // Render chế độ xem ban đầu sau khi xác thực
            });

            // Lắng nghe các thay đổi trong bộ sưu tập bài tập
            onSnapshot(collection(db, `artifacts/${appId}/public/data/exercises`), (snapshot) => {
                exercises = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Bài tập được cập nhật:", exercises);
                // Render lại chế độ xem hiện tại để hiển thị dữ liệu mới
                renderView();
            }, (error) => {
                console.error("Lỗi khi tải bài tập:", error);
                const mainContent = document.getElementById('app-main-content');
                if (mainContent) {
                    mainContent.innerHTML = '<div class="text-center text-red-600 text-xl mt-10">Lỗi khi tải bài tập. Vui lòng kiểm tra kết nối internet hoặc cấu hình Firebase.</div>';
                }
            });
        };
    </script>
</body>
</html>
